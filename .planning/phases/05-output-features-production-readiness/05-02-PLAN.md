---
phase: 05-output-features-production-readiness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/transform/route.ts
  - vercel.json
autonomous: true

must_haves:
  truths:
    - "Vercel function allows 60 seconds for transformation"
    - "App is deployed and accessible on Vercel"
    - "Environment variables are configured in production"
    - "Error handling includes retry logic with exponential backoff (already implemented in Phase 4)"
  artifacts:
    - path: "app/api/transform/route.ts"
      provides: "maxDuration export"
      contains: "maxDuration = 60"
    - path: "vercel.json"
      provides: "Vercel configuration"
      exports: []
    - path: "lib/gemini.ts"
      provides: "Exponential backoff retry logic (from Phase 4)"
      contains: "callWithRetry"
  key_links:
    - from: "app/api/transform/route.ts"
      to: "Vercel runtime"
      via: "maxDuration export"
      pattern: "export const maxDuration"
    - from: "app/api/transform/route.ts"
      to: "lib/gemini.ts"
      via: "transformImage with built-in retry"
      pattern: "transformImage"
---

<objective>
Production deployment configuration

Purpose: Configure Vercel function timeout to handle Gemini processing delays (up to 60 seconds) and deploy the app to production with proper environment variables.

Output: maxDuration configured in API route, app deployed to Vercel

Note: Exponential backoff with jitter is already implemented in lib/gemini.ts (Phase 4, 04-01-PLAN). The callWithRetry function handles 429/503 errors with 1s-60s backoff and 5 retries. No additional retry logic needed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-output-features-production-readiness/05-RESEARCH.md

# Key existing files
@app/api/transform/route.ts
@lib/gemini.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Vercel function timeout and verify existing retry logic</name>
  <files>app/api/transform/route.ts, vercel.json</files>
  <action>
    1. Verify exponential backoff exists in lib/gemini.ts:
       ```bash
       grep -n "callWithRetry\|exponential\|backoff\|RETRY_CONFIG" lib/gemini.ts
       ```
       Expected: RETRY_CONFIG with maxRetries: 5, baseDelay: 1000, maxDelay: 60000
       This was implemented in Phase 4 (04-01-PLAN) and handles 429/503 errors.

    2. Add maxDuration export to `app/api/transform/route.ts`:
       - Add at the top of the file, after imports: `export const maxDuration = 60;`
       - This tells Vercel to allow up to 60 seconds for the function

    3. Create `vercel.json` as backup configuration:
       ```json
       {
         "$schema": "https://openapi.vercel.sh/vercel.json",
         "functions": {
           "app/api/transform/route.ts": {
             "maxDuration": 60
           }
         }
       }
       ```
       Note: The route export is the primary method; vercel.json is fallback.

    4. Verify build works with new config:
       ```bash
       npm run build
       ```
  </action>
  <verify>
    - `grep "callWithRetry" lib/gemini.ts` confirms retry logic exists
    - `grep "maxRetries: 5" lib/gemini.ts` confirms 5 retries configured
    - `grep "maxDuration" app/api/transform/route.ts` shows export
    - `cat vercel.json` shows the functions config
    - `npm run build` succeeds
  </verify>
  <done>API route configured with 60-second timeout, vercel.json created, existing retry logic verified</done>
</task>

<task type="auto">
  <name>Task 2: Deploy to Vercel</name>
  <files>None (deployment only)</files>
  <action>
    1. Check if Vercel CLI is available:
       ```bash
       vercel --version || npm install -g vercel
       ```

    2. Link project to Vercel (if not already linked):
       ```bash
       vercel link
       ```
       - If prompted, create new project
       - Project name: beautify (or accept suggestion)

    3. Set environment variables for production:
       ```bash
       # Check if GEMINI_API_KEY is in local env
       # Then add to Vercel
       vercel env add GEMINI_API_KEY production
       vercel env add GEMINI_API_KEY preview
       ```
       Note: If CLI prompts for value, enter the API key.
       If this fails due to missing auth, create a checkpoint.

    4. Deploy to production:
       ```bash
       vercel --prod
       ```

    5. Test the deployed app:
       - Visit the production URL
       - Upload an image
       - Click Create
       - Verify transformation works
       - Download the result
  </action>
  <verify>
    - `vercel ls` shows the project
    - Production URL is accessible
    - Transformation works on production
    - Downloaded file has MsFrozen prefix
  </verify>
  <done>App deployed to Vercel with GEMINI_API_KEY configured, transformation working in production</done>
</task>

</tasks>

<verification>
1. Run `npm run build` locally - must succeed
2. Check maxDuration in route file
3. Verify retry logic exists: `grep -A5 "RETRY_CONFIG" lib/gemini.ts`
4. Visit production URL from `vercel --prod` output
5. Complete full flow: upload -> transform -> compare -> download
6. Verify no timeout errors during transformation
</verification>

<success_criteria>
- maxDuration = 60 exported from API route
- vercel.json exists with backup config
- Exponential backoff verified in lib/gemini.ts (5 retries, 1s-60s delay with jitter)
- App deployed to Vercel production
- GEMINI_API_KEY environment variable set
- Full transformation flow works in production
- No 504 timeout errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-output-features-production-readiness/05-02-SUMMARY.md`
</output>

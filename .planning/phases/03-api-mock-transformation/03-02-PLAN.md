---
phase: 03-api-mock-transformation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - components/upload-zone.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 'Create' button after uploading an image"
    - "Clicking 'Create' sends base64 image to /api/transform"
    - "Button shows disabled loading state during transformation"
    - "Transformed image replaces preview with smooth fade transition"
    - "Error messages display when transformation fails"
    - "User can download transformed image"
    - "User can start over with new image"
  artifacts:
    - path: "components/upload-zone.tsx"
      provides: "Upload zone with transformation flow"
      min_lines: 280
  key_links:
    - from: "components/upload-zone.tsx"
      to: "/api/transform"
      via: "fetch POST request"
      pattern: "fetch.*api/transform"
---

<objective>
Integrate the transform API with the upload zone UI, adding the Create button, loading states, and transformed result display.

Purpose: Complete the client-server communication loop, proving the full flow works before real AI integration.
Output: UploadZone component with transform capability showing mock-transformed images.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-api-mock-transformation/03-CONTEXT.md
@.planning/phases/03-api-mock-transformation/03-01-SUMMARY.md
@components/upload-zone.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add transformation state and API call</name>
  <files>components/upload-zone.tsx</files>
  <action>
Extend UploadZone component with transformation capability:

**New state:**
- `isTransforming: boolean` - tracks API call in progress
- `transformedUrl: string | null` - holds transformed image data URL
- `transformError: string | null` - holds transformation-specific errors

**New handler - handleTransform:**
```typescript
async function handleTransform() {
  if (!previewUrl) return

  setIsTransforming(true)
  setTransformError(null)

  try {
    const response = await fetch('/api/transform', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: previewUrl }),
    })

    const result = await response.json()

    if (!response.ok) {
      throw new Error(result.error || `HTTP ${response.status}`)
    }

    if (result.success) {
      setTransformedUrl(result.transformedImage)
    } else {
      throw new Error(result.error || 'Transformation failed')
    }
  } catch (err) {
    setTransformError(err instanceof Error ? err.message : 'Transformation failed')
  } finally {
    setIsTransforming(false)
  }
}
```

**Update handleReset:**
- Also clear `transformedUrl` and `transformError`

Keep existing upload/preview logic intact. The transform flow activates AFTER preview is shown.
  </action>
  <verify>
`grep -l "isTransforming" components/upload-zone.tsx` returns the file
`grep -l "api/transform" components/upload-zone.tsx` returns the file
`npx tsc --noEmit` passes
  </verify>
  <done>
Component has state and handler for transformation. API call sends previewUrl (base64) to /api/transform endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update UI for transformation flow</name>
  <files>components/upload-zone.tsx</files>
  <action>
Update the preview state UI to support the transformation flow:

**When preview is shown (previewUrl exists, not transformed yet):**
- Show the preview image
- Show "Create" button (primary style) that calls handleTransform
- Show "New" button (outline style) to reset
- Create button: disabled and shows Loader2 spinner when isTransforming
- Keep Create button in same position during loading (don't hide it)

**When transformed (transformedUrl exists):**
- Show transformed image instead of preview (with animate-in fade-in)
- Show "Download" button (links to transformedUrl)
- Show "New" button to reset
- Hide Create button (transformation complete)

**Error handling:**
- Show transformError below buttons if set (red text, same style as existing error)
- Clear transformError when starting new transform

**UI details from CONTEXT.md:**
- Transform button stays in place with loading indicator (Loader2 spinner)
- Smooth fade transition when transformed result appears (animate-in fade-in duration-300)
- Use existing Button and icon patterns (Download, RefreshCw, Loader2)

**Button layout in preview state:**
```tsx
<div className="flex gap-3">
  {!transformedUrl && (
    <Button onClick={handleTransform} disabled={isTransforming}>
      {isTransforming ? (
        <Loader2 className="h-4 w-4 animate-spin" />
      ) : (
        <Sparkles className="h-4 w-4" />
      )}
      {isTransforming ? 'Creating...' : 'Create'}
    </Button>
  )}
  {transformedUrl && (
    <Button asChild>
      <a href={transformedUrl} download={fileName ? `transformed-${fileName}` : 'transformed-image'}>
        <Download className="h-4 w-4" />
        Download
      </a>
    </Button>
  )}
  <Button variant="outline" onClick={handleReset}>
    <RefreshCw className="h-4 w-4" />
    New
  </Button>
</div>
```

Import Sparkles from lucide-react for the Create button icon.
  </action>
  <verify>
Run dev server and test manually:
1. Upload an image - see Create and New buttons
2. Click Create - button shows spinner and "Creating..."
3. After mock transform - see Download and New buttons
4. Click Download - downloads the image
5. Click New - returns to upload state

Also verify:
- `npx tsc --noEmit` passes
- Button positions don't shift during loading
  </verify>
  <done>
UI shows Create button in preview state, loading spinner during transform, Download button after transform. Smooth fade transition on transformed result.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify complete flow and error states</name>
  <files>components/upload-zone.tsx</files>
  <action>
Test and verify the complete transformation flow:

**Test cases:**
1. Upload valid image -> shows preview with Create button
2. Click Create -> button disabled with spinner
3. Transform completes -> shows transformed image with Download button
4. Download works -> file downloads with "transformed-" prefix
5. New button resets to upload state

**Error test cases:**
6. Rate limit (hit /api/transform 6 times quickly) -> shows error message
7. Large file (if you can test) -> shows size error

**Verify:**
- No TypeScript errors: `npx tsc --noEmit`
- No console errors during flow
- Transitions are smooth (animate-in class working)

If any issues found during testing, fix them. The flow must work end-to-end.
  </action>
  <verify>
Complete manual test:
```
1. npm run dev
2. Open http://localhost:3000
3. Upload a JPEG/PNG image
4. See Create + New buttons
5. Click Create, see loading state
6. See transformed image appear
7. Click Download, file saves
8. Click New, back to upload
9. Repeat 6 times quickly, see rate limit error
```
  </verify>
  <done>
Complete transformation flow works: upload -> preview -> create -> loading -> result -> download/new. Error states display properly. Rate limiting shows appropriate message.
  </done>
</task>

</tasks>

<verification>
Full end-to-end verification:

1. **TypeScript compiles:** `npx tsc --noEmit`

2. **Manual flow test:**
   - Start dev server: `npm run dev`
   - Navigate to http://localhost:3000
   - Upload an image (drag or click)
   - Verify Create and New buttons appear
   - Click Create
   - Verify button shows spinner and "Creating..."
   - Verify transformed image appears with fade animation
   - Verify Download and New buttons appear
   - Click Download - file saves
   - Click New - returns to upload state

3. **Error handling test:**
   - Upload image, click Create 6 times quickly
   - Should see rate limit error message

4. **Responsive check:**
   - Test on narrow viewport (mobile simulation)
   - Buttons should wrap gracefully
</verification>

<success_criteria>
- Create button appears after uploading image
- Clicking Create sends base64 to /api/transform
- Button shows loading state (disabled + spinner) during request
- Transformed image displays with smooth fade transition
- Download button downloads the transformed image
- New button resets entire state
- Error messages display for API failures and rate limits
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-api-mock-transformation/03-02-SUMMARY.md`
</output>

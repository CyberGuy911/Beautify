---
phase: 03-api-mock-transformation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/rate-limit.ts
  - lib/image-validation.ts
  - app/api/transform/route.ts
autonomous: true

must_haves:
  truths:
    - "API route accepts POST requests at /api/transform"
    - "Invalid base64 data returns 400 error with clear message"
    - "Images exceeding 4.5MB are rejected with size error"
    - "More than 5 requests per minute from same IP returns 429"
    - "Valid image returns mock transformed image (same image back)"
  artifacts:
    - path: "lib/rate-limit.ts"
      provides: "In-memory rate limiter with Map cleanup"
      exports: ["checkRateLimit"]
    - path: "lib/image-validation.ts"
      provides: "Base64 validation and size checking"
      exports: ["validateBase64Image"]
    - path: "app/api/transform/route.ts"
      provides: "POST handler for transformation"
      exports: ["POST"]
  key_links:
    - from: "app/api/transform/route.ts"
      to: "lib/rate-limit.ts"
      via: "import checkRateLimit"
      pattern: "import.*checkRateLimit.*from.*rate-limit"
    - from: "app/api/transform/route.ts"
      to: "lib/image-validation.ts"
      via: "import validateBase64Image"
      pattern: "import.*validateBase64Image.*from.*image-validation"
---

<objective>
Create the API route infrastructure for image transformation with validation and rate limiting.

Purpose: Establish server-side foundation for client-server communication before real AI integration.
Output: Working POST endpoint at /api/transform that validates input and returns mock responses.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@.planning/phases/03-api-mock-transformation/03-RESEARCH.md
@lib/data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rate limiting and validation utilities</name>
  <files>lib/rate-limit.ts, lib/image-validation.ts</files>
  <action>
Create two utility files:

**lib/rate-limit.ts:**
- In-memory Map-based rate limiter
- `checkRateLimit(identifier: string, limit?: number, windowMs?: number)` function
- Returns `{ allowed: boolean; remaining: number }`
- Default: 5 requests per 60000ms (1 minute)
- Include cleanup interval (every 5 minutes) to prevent memory leaks
- Type the RateLimitRecord interface

**lib/image-validation.ts:**
- `validateBase64Image(base64String: string)` function
- Strips data URL prefix (data:image/xxx;base64,) before validation
- Uses Node.js Buffer.from() to decode and measure size
- Rejects images > 4.5MB with clear error
- Returns `{ valid: true, buffer, sizeInMB }` or `{ valid: false, error: string }`
- Include `calculateBase64Size(base64String: string): number` helper

Follow patterns from RESEARCH.md. Use TypeScript with explicit types.
  </action>
  <verify>
Files exist and have correct exports:
- `grep -l "checkRateLimit" lib/rate-limit.ts`
- `grep -l "validateBase64Image" lib/image-validation.ts`
- `npx tsc --noEmit` passes
  </verify>
  <done>
Rate limiter tracks requests per identifier with auto-cleanup. Validator decodes base64, checks size, returns typed results.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create transform API route</name>
  <files>app/api/transform/route.ts</files>
  <action>
Create POST route handler at `app/api/transform/route.ts`:

**Request handling:**
- Import NextRequest, NextResponse from 'next/server'
- Import checkRateLimit from '@/lib/rate-limit'
- Import validateBase64Image from '@/lib/image-validation'
- Export async POST function

**Flow:**
1. Extract client identifier from headers (x-forwarded-for -> x-real-ip -> 'unknown')
2. Call checkRateLimit - return 429 if not allowed
3. Parse body with `await request.json()` - catch JSON parse errors
4. Validate `image` field exists and is string - return 400 if not
5. Call validateBase64Image - return 400 with validation error if invalid
6. Mock transformation: return the same image back with success message
7. Wrap everything in try-catch, return 500 on unexpected errors

**Response format:**
- Success: `{ success: true, transformedImage: string, message: string }`
- Error: `{ success: false, error: string }`

Follow RESEARCH.md patterns exactly. Include proper error messages for each failure case.
  </action>
  <verify>
Test with curl:
```bash
# Test rate limit - should succeed first, fail after 5
for i in {1..6}; do curl -s -X POST http://localhost:3000/api/transform -H "Content-Type: application/json" -d '{"image":"invalid"}' | jq -r '.error // .success'; done

# Test validation errors
curl -s -X POST http://localhost:3000/api/transform -H "Content-Type: application/json" -d '{}' | jq  # Should show "image field required"
curl -s -X POST http://localhost:3000/api/transform -H "Content-Type: application/json" -d '{"image":"not-base64!!"}' | jq  # Should show validation error

# Test valid base64 (small test image)
curl -s -X POST http://localhost:3000/api/transform -H "Content-Type: application/json" -d '{"image":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="}' | jq  # Should show success: true
```
  </verify>
  <done>
POST /api/transform validates input, enforces rate limits, and returns mock transformation. All error cases return appropriate HTTP status codes and clear messages.
  </done>
</task>

</tasks>

<verification>
Run the dev server and verify all API behaviors:

```bash
# Start dev server
npm run dev &
sleep 3

# 1. Valid request returns success
curl -s -X POST http://localhost:3000/api/transform \
  -H "Content-Type: application/json" \
  -d '{"image":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="}' \
  | jq '.success'
# Expected: true

# 2. Missing image returns 400
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:3000/api/transform \
  -H "Content-Type: application/json" \
  -d '{}'
# Expected: 400

# 3. Invalid base64 returns 400
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:3000/api/transform \
  -H "Content-Type: application/json" \
  -d '{"image":"not-valid-base64!!!"}'
# Expected: 400

# 4. TypeScript compiles
npx tsc --noEmit
```
</verification>

<success_criteria>
- POST /api/transform accepts valid base64 images and returns them
- Invalid requests return 400 with descriptive error messages
- Rate limiting returns 429 after 5 requests in 60 seconds
- All TypeScript compiles without errors
- No external dependencies added (uses native Node.js Buffer)
</success_criteria>

<output>
After completion, create `.planning/phases/03-api-mock-transformation/03-01-SUMMARY.md`
</output>

---
phase: 04-gemini-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - lib/gemini.ts
  - lib/prompt-engineering.ts
  - app/api/transform/route.ts
autonomous: true
user_setup:
  - service: google-ai-studio
    why: "Gemini API for image transformation"
    env_vars:
      - name: GEMINI_API_KEY
        source: "Google AI Studio -> Get API Key -> Create API key"

must_haves:
  truths:
    - "API route sends image + prompt to Gemini and receives transformed image"
    - "Exponential backoff retries on 429/503 errors up to 5 times"
    - "Safety filter blocks return user-friendly error messages"
    - "Rate limit errors return 'Service is busy' message"
  artifacts:
    - path: "lib/gemini.ts"
      provides: "Gemini client with retry logic and transform function"
      exports: ["transformImage"]
    - path: "lib/prompt-engineering.ts"
      provides: "Mystical cosmic portrait prompt"
      exports: ["generateMysticalPrompt"]
    - path: "app/api/transform/route.ts"
      provides: "Real Gemini transformation endpoint"
      exports: ["POST"]
  key_links:
    - from: "app/api/transform/route.ts"
      to: "lib/gemini.ts"
      via: "transformImage import"
      pattern: "import.*transformImage.*from.*gemini"
    - from: "lib/gemini.ts"
      to: "@google/genai"
      via: "GoogleGenAI client"
      pattern: "new GoogleGenAI"
    - from: "lib/gemini.ts"
      to: "lib/data.ts"
      via: "getGeminiApiKey import"
      pattern: "getGeminiApiKey"
---

<objective>
Connect the transform API route to Google's Gemini API for real image transformation.

Purpose: Replace mock transformation with actual AI-powered mystical cosmic portrait generation
Output: Working Gemini integration with retry logic, error handling, and prompt engineering
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase research (CRITICAL - use these patterns)
@.planning/phases/04-gemini-integration/04-RESEARCH.md

# Existing artifacts to modify/use
@lib/data.ts
@lib/image-validation.ts
@app/api/transform/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install SDK and create Gemini client with retry logic</name>
  <files>package.json, lib/gemini.ts</files>
  <action>
1. Install the Gemini SDK:
   ```bash
   npm install @google/genai
   ```

2. Create `lib/gemini.ts` with:
   - Import 'server-only' at top (compile-time enforcement)
   - Import GoogleGenAI from @google/genai
   - Import getGeminiApiKey from @/lib/data

   - Create `callWithRetry<T>` helper function:
     - Config: maxRetries=5, baseDelay=1000ms, maxDelay=60000ms
     - Retry on errors containing: '429', '503', 'RESOURCE_EXHAUSTED', 'UNAVAILABLE'
     - Exponential backoff: `baseDelay * 2^attempt + random(0-1000)ms`
     - Cap delay at maxDelay
     - Throw after maxRetries exhausted

   - Create `transformImage(imageBase64: string, mimeType: string)` function:
     - Returns Promise<{ success: boolean, transformedImage?: string, error?: string }>
     - Initialize GoogleGenAI with apiKey from getGeminiApiKey()
     - Strip data URI prefix: `imageBase64.replace(/^data:image\/\w+;base64,/, '')`
     - Call Gemini API inside callWithRetry wrapper
     - Use model: 'gemini-2.5-flash-image'
     - Send contents array with text part (prompt) and inlineData part (image)
     - Check response.promptFeedback?.blockReason for input safety block
     - Check candidate.finishReason === 'SAFETY' for output safety block
     - Extract transformed image from candidate.content.parts[0].inlineData.data
     - Return with data URI prefix: `data:image/jpeg;base64,${transformedData}`
     - Catch errors and return user-friendly messages:
       - 429/RESOURCE_EXHAUSTED -> "Service is busy. Please try again in a moment."
       - 503/UNAVAILABLE -> "Service temporarily unavailable. Please try again."
       - 403/PERMISSION_DENIED -> "API authentication failed. Please contact support."
       - Default -> "Transformation failed. Please try again."

NOTE: Do NOT use the Files API for image input - it fails silently for image-to-image. Use base64 inlineData.
  </action>
  <verify>
    - `npm ls @google/genai` shows package installed
    - `lib/gemini.ts` exists with transformImage export
    - File imports 'server-only' at top
  </verify>
  <done>
    - @google/genai installed in package.json
    - lib/gemini.ts exports transformImage function with exponential backoff
    - All error types have user-friendly messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Create prompt engineering module</name>
  <files>lib/prompt-engineering.ts</files>
  <action>
Create `lib/prompt-engineering.ts` with:

1. Export `generateMysticalPrompt()` function that returns the transformation prompt string

2. Prompt content (describe the scene, don't just list keywords):
```
Transform this portrait into a mystical cosmic masterpiece.

Create a portrait with:
- Ethereal cosmic atmosphere with deep space backgrounds (nebulas, stars, galaxies)
- Soft magical lighting with subtle sparkles and dreamy glow around the subject
- Mystical color palette: purples, deep blues, cosmic teals, golden highlights
- Enchanting vibe without losing the subject's realistic features and expressions
- Creative cosmic symbols subtly integrated (constellations, celestial patterns)
- Dramatic yet soft lighting that enhances facial features
- Ultra-realistic finish with 4K detail and cinematic color grading

Style: Fantasy portrait photography with cosmic elements, professional magazine quality, warm golden highlights, sharp facial details, whimsical magical atmosphere.
```

This prompt follows Google's "describe the scene" best practice from their Nano Banana prompting guide.
  </action>
  <verify>
    - `lib/prompt-engineering.ts` exists
    - File exports generateMysticalPrompt function
  </verify>
  <done>
    - Prompt engineering module ready with mystical cosmic portrait prompt
    - Prompt is descriptive (100-150 words) not just keywords
  </done>
</task>

<task type="auto">
  <name>Task 3: Update API route to use real Gemini transformation</name>
  <files>app/api/transform/route.ts</files>
  <action>
Modify `app/api/transform/route.ts`:

1. Add import at top:
   ```typescript
   import { transformImage } from '@/lib/gemini'
   ```

2. Replace the mock transformation section (lines ~51-53) with real call:
   ```typescript
   // Determine MIME type from data URL prefix
   const mimeTypeMatch = image.match(/^data:(image\/\w+);base64,/)
   const mimeType = mimeTypeMatch ? mimeTypeMatch[1] : 'image/jpeg'

   // Call Gemini for real transformation
   const result = await transformImage(image, mimeType)

   if (!result.success) {
     return NextResponse.json(
       {
         success: false,
         error: result.error || 'Transformation failed'
       },
       { status: 500 }
     )
   }

   return NextResponse.json({
     success: true,
     transformedImage: result.transformedImage
   })
   ```

3. Remove the old mock response and "message: 'Mock transformation complete'" field

Keep existing:
- Rate limiting logic (checkRateLimit)
- JSON validation
- Base64 validation (validateBase64Image)
- Error handling for SyntaxError
  </action>
  <verify>
    - `npm run build` completes without errors
    - Route imports transformImage from lib/gemini
    - No mock transformation code remains
  </verify>
  <done>
    - API route calls real Gemini transformation
    - Existing rate limiting and validation preserved
    - Error responses use Gemini result.error
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Server starts: `npm run dev`
3. With valid GEMINI_API_KEY in .env.local:
   - Upload image and click Create
   - Should see transformed cosmic portrait (2-5 seconds)
   - Transformed image should have mystical cosmic style
4. Without API key:
   - Should see "GEMINI_API_KEY is not configured" error
</verification>

<success_criteria>
- @google/genai SDK installed and working
- lib/gemini.ts handles all error cases with user-friendly messages
- lib/prompt-engineering.ts provides mystical cosmic prompt
- API route transforms images using real Gemini API
- Exponential backoff handles 429/503 errors gracefully
- Safety filter blocks return clear user messages
</success_criteria>

<output>
After completion, create `.planning/phases/04-gemini-integration/04-01-SUMMARY.md`
</output>

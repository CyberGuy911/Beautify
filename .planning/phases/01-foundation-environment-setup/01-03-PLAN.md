---
phase: 01-foundation-environment-setup
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .env.local
  - .env.example
  - next.config.ts
  - lib/data.ts
  - .gitignore
autonomous: false

must_haves:
  truths:
    - "API key is configured but stays server-side only"
    - "Bundle analyzer confirms no secrets in client bundle"
    - "Data Access Layer enforces server-only execution"
    - "Google Cloud billing alerts are documented for manual setup"
  artifacts:
    - path: ".env.local"
      provides: "Environment variables for local development"
      contains: "GEMINI_API_KEY"
    - path: ".env.example"
      provides: "Template for environment variables"
      contains: "GEMINI_API_KEY"
    - path: "lib/data.ts"
      provides: "Data Access Layer with server-only enforcement"
      contains: "server-only"
    - path: "next.config.ts"
      provides: "Next.js config with bundle analyzer"
      contains: "bundle-analyzer"
  key_links:
    - from: "lib/data.ts"
      to: ".env.local"
      via: "process.env access"
      pattern: "process\\.env\\.GEMINI_API_KEY"
    - from: "lib/data.ts"
      to: "server-only"
      via: "import enforcement"
      pattern: "import.*server-only"

user_setup:
  - service: google-cloud
    why: "Billing protection for Gemini API usage"
    dashboard_config:
      - task: "Create budget with alerts at $50, $100, $200 thresholds"
        location: "Google Cloud Console -> Billing -> Budgets & alerts"
        steps:
          - "Go to https://console.cloud.google.com/billing"
          - "Select your billing account"
          - "Click 'Budgets & alerts' in left sidebar"
          - "Click 'CREATE BUDGET'"
          - "Name: 'Beautify API Budget'"
          - "Set budget amount (e.g., $200/month)"
          - "Set alert thresholds: 50%, 100%, 200% (sends email at $100, $200, $400)"
          - "Enable email notifications to billing admins"
          - "Click 'Finish'"
  - service: google-ai
    why: "API key for Gemini integration (used in Phase 4)"
    env_vars:
      - name: GEMINI_API_KEY
        source: "Google AI Studio -> Get API key -> Create API key"
        url: "https://aistudio.google.com/apikey"
---

<objective>
Configure environment variable security and document billing alert setup.

Purpose: Ensure API keys never leak to the client bundle and establish cost controls before any AI integration. Security must be verified before Phase 4.

Output: Secure environment configuration with Data Access Layer, bundle analyzer verification, and documented billing alert setup process.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-environment-setup/01-CONTEXT.md
@.planning/phases/01-foundation-environment-setup/01-RESEARCH.md
@.planning/phases/01-foundation-environment-setup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure environment variables and Data Access Layer</name>
  <files>
    - .env.local
    - .env.example
    - lib/data.ts
    - .gitignore
    - package.json
  </files>
  <action>
    1. Install server-only package:
       ```bash
       npm install server-only
       ```

    2. Create `.env.local` with placeholder:
       ```bash
       # Gemini API Key (get from https://aistudio.google.com/apikey)
       # IMPORTANT: Never use NEXT_PUBLIC_ prefix - this must stay server-side
       GEMINI_API_KEY=your-api-key-here

       # Enable bundle analyzer (run: ANALYZE=true npm run build)
       # ANALYZE=true
       ```

    3. Create `.env.example` (safe to commit, no secrets):
       ```bash
       # Gemini API Key (get from https://aistudio.google.com/apikey)
       # Copy this file to .env.local and fill in your key
       GEMINI_API_KEY=your-api-key-here
       ```

    4. Verify `.gitignore` includes `.env.local`:
       ```bash
       # Check if .env.local is in .gitignore
       grep ".env.local" .gitignore
       # If not present, add it
       ```
       Next.js create-next-app should have added this, but verify.

    5. Create `lib/data.ts` - Data Access Layer:
       ```typescript
       import 'server-only'

       // This file can only be imported in Server Components or API Routes
       // Importing in a Client Component will cause a build error

       /**
        * Get the Gemini API key from environment variables.
        * This function enforces server-only access to the API key.
        *
        * @throws Error if GEMINI_API_KEY is not configured
        */
       export function getGeminiApiKey(): string {
         const apiKey = process.env.GEMINI_API_KEY

         if (!apiKey || apiKey === 'your-api-key-here') {
           throw new Error(
             'GEMINI_API_KEY is not configured. ' +
             'Get your key from https://aistudio.google.com/apikey ' +
             'and add it to .env.local'
           )
         }

         return apiKey
       }

       /**
        * Validate that the environment is properly configured.
        * Call this at app startup to fail fast if misconfigured.
        */
       export function validateEnvironment(): void {
         // List all required env vars here
         const required = ['GEMINI_API_KEY']
         const missing = required.filter(
           key => !process.env[key] || process.env[key] === 'your-api-key-here'
         )

         if (missing.length > 0) {
           console.warn(
             `Missing environment variables: ${missing.join(', ')}. ` +
             'Some features will not work until configured.'
           )
         }
       }
       ```

       Key points:
       - `import 'server-only'` at top - causes build error if imported in client code
       - Function validates key exists and isn't placeholder
       - Helpful error messages guide developer to fix
  </action>
  <verify>
    - `.env.local` exists with GEMINI_API_KEY placeholder
    - `.env.example` exists (safe to commit)
    - `lib/data.ts` exists with `server-only` import
    - `.gitignore` contains `.env.local`
    - `npm run build` succeeds (no import errors)
  </verify>
  <done>
    Environment variables configured with Data Access Layer. server-only package enforces server-side access.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add bundle analyzer and verify security</name>
  <files>
    - next.config.ts
    - package.json
  </files>
  <action>
    1. Install bundle analyzer:
       ```bash
       npm install --save-dev @next/bundle-analyzer
       ```

    2. Update `next.config.ts` to include bundle analyzer:
       ```typescript
       import type { NextConfig } from "next";

       const withBundleAnalyzer = require('@next/bundle-analyzer')({
         enabled: process.env.ANALYZE === 'true',
       })

       const nextConfig: NextConfig = {
         /* config options here */
       };

       export default withBundleAnalyzer(nextConfig);
       ```

    3. Run bundle analysis:
       ```bash
       ANALYZE=true npm run build
       ```
       This opens browser with bundle visualization.

    4. Verify security in the analysis:
       - Look at client bundle (client.html that opens automatically)
       - Search for "GEMINI" or "API_KEY" in the visualization
       - These strings should NOT appear in client bundles
       - They should only appear in server bundles (if at all)

       If the browser doesn't open automatically:
       ```bash
       # Check for generated files
       ls -la .next/analyze/
       # Open client.html manually
       ```

    5. Additional verification - check built files:
       ```bash
       # Search for any env var leaks in client JS
       grep -r "GEMINI" .next/static/ 2>/dev/null || echo "No leaks found - good!"
       grep -r "API_KEY" .next/static/ 2>/dev/null || echo "No leaks found - good!"
       ```
  </action>
  <verify>
    - `@next/bundle-analyzer` is in devDependencies
    - `next.config.ts` includes bundle analyzer wrapper
    - `ANALYZE=true npm run build` generates analysis
    - Client bundle does NOT contain "GEMINI" or "API_KEY" strings
    - grep commands return no matches in `.next/static/`
  </verify>
  <done>
    Bundle analyzer configured. Verified that API key does not leak to client bundle.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Environment security configuration:
    - Data Access Layer with server-only enforcement
    - Bundle analyzer for verification
    - Verified no API key leaks to client
  </what-built>
  <how-to-verify>
    1. **Verify bundle analyzer results:**
       - Run: `ANALYZE=true npm run build`
       - In the client.html visualization that opens:
         - Search (Ctrl+F) for "GEMINI" - should find 0 results
         - Search for "API_KEY" - should find 0 results
       - If found in client bundle, this is a security issue

    2. **Set up Google Cloud billing alerts (manual step):**
       - Go to https://console.cloud.google.com/billing
       - Select your billing account
       - Click "Budgets & alerts" in left sidebar
       - Click "CREATE BUDGET"
       - Configure:
         - Name: "Beautify API Budget"
         - Scope: All projects (or specific project)
         - Amount: $200/month (or your preferred limit)
         - Thresholds: 25%, 50%, 75%, 100%, 200%
           (Alerts at $50, $100, $150, $200, $400)
         - Email notifications: Enabled
       - Click "Finish"

    3. **Get Gemini API key (if not done):**
       - Go to https://aistudio.google.com/apikey
       - Click "Create API key"
       - Copy the key
       - Add to `.env.local`:
         ```
         GEMINI_API_KEY=your-actual-key-here
         ```

    **Note:** The API key is not used until Phase 4, but billing alerts should be set up now as a safety measure.
  </how-to-verify>
  <resume-signal>
    Type "approved" when:
    - Bundle analyzer confirms no leaks
    - Billing alerts are configured at $50/$100/$200 thresholds
    - (Optional) API key is added to .env.local
  </resume-signal>
</task>

</tasks>

<verification>
Run these checks after completing all tasks:

1. **Environment files exist:**
   ```bash
   ls -la .env.local .env.example
   ```

2. **server-only enforcement works:**
   ```bash
   # This should be in package.json
   grep "server-only" package.json
   ```

3. **Data Access Layer exists:**
   ```bash
   cat lib/data.ts | head -5
   # Should show: import 'server-only'
   ```

4. **Bundle analyzer configured:**
   ```bash
   grep "bundle-analyzer" next.config.ts
   ```

5. **No secrets in client bundle:**
   ```bash
   ANALYZE=true npm run build
   # Then search client.html for secrets
   grep -r "GEMINI" .next/static/ || echo "Safe!"
   ```

6. **Build succeeds:**
   ```bash
   npm run build
   ```
</verification>

<success_criteria>
- [ ] `.env.local` created with GEMINI_API_KEY placeholder
- [ ] `.env.example` created (committable template)
- [ ] `lib/data.ts` created with server-only import
- [ ] `@next/bundle-analyzer` installed and configured
- [ ] Bundle analysis confirms no API key in client bundle
- [ ] Google Cloud billing alerts configured (manual verification)
- [ ] `npm run build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-environment-setup/01-03-SUMMARY.md`
</output>
